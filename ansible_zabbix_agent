---
- name: Install Zabbix Agent
  hosts: qq-game-worker2-ibm 
  become: true
  
  vars:
    zabbix_server_port: 10051
    #for cloud IBM
    zabbix_server_ip: 103.186.202.4
    #for local semanan
    #zabbix_server_ip: 192.168.111.5,172.99.99.1
    

  tasks:
#    - name: Install Zabbix Agent2 Centos
#      shell: yum update --nogpgcheck -y && yum install pcre2 -y && wget https://repo.zabbix.com/zabbix/6.4/rhel/7/x86_64/zabbix-agent2-6.4.1-release1.el7.noarch.rpm && rpm -i zabbix-agent2-6.4.1-release1.el7.noarch.rpm 
  
    - name: Install Zabbix Agent2 Ubuntu
      shell: wget https://repo.zabbix.com/zabbix/6.4/ubuntu/pool/main/z/zabbix-release/zabbix-release_6.4-1+ubuntu20.04_all.deb && dpkg -i zabbix-release_6.4-1+ubuntu20.04_all.deb && apt update
    
    - name: Install Zabbix Agent2 package
      package:
        name: zabbix-agent2
        state: latest
#
    - name: Configure Zabbix Agent2
      lineinfile:
        path: /etc/zabbix/zabbix_agent2.conf
        regexp: '^Server='
        line: 'Server={{ zabbix_server_ip }}'
      notify: restart zabbix-agent2
#
    - name: Configure Zabbix Agent2
      lineinfile:
        path: /etc/zabbix/zabbix_agent2.conf
        regexp: '^ServerActive='
        line: 'ServerActive={{ zabbix_server_ip }}:{{ zabbix_server_port }}'
      notify: restart zabbix-agent2

    #- name: Add zabbix to docker groups
    #  shell: "sudo usermod -aG docker zabbix"

  handlers:
    - name: restart zabbix-agent2
      service:
        name: zabbix-agent2
        state: restarted
